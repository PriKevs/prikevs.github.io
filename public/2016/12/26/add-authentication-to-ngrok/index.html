<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 给ngrok添加身份验证 · Kevince's Blog</title><meta name="description" content="给ngrok添加身份验证 - Kevince Boole"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Kevince's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="mailto:prikevs@gmail.com" target="_self" class="nav-list-link">EMAIL</a></li><li class="nav-list-item"><a href="https://github.com/prikevs" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">给ngrok添加身份验证</h1><div class="post-info">Dec 26, 2016</div><div class="post-content"><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>最近有个同学需要在校外访问学校内网，然而学校的SSL VPN出了问题，只能用自己的方式来解决了。<br>听到这个需求，我的第一反应是用N2N VPN，使用UDP Hole Punching的方式来穿透学校内网组建VPN。<br>于是立马写了一套简单的工具来检测学校的网络是否支持UPD Hole Punching，不过这不是今天的主题，以后有机会再说。</p>
<p>由于N2N年久失修，对Mac用户也不友好，我最终使用来一个更简单的方式——在内网本地搭一个shadowsoks的server，然后用ngrok将端口暴露到外网服务器，直接用ss的客户端就可以将流量转接到本地了。</p>
<p>首先我简单介绍一下ngrok:</p>
<blockquote>
<p><a href="https://github.com/inconshreveable/ngrok" target="_blank" rel="external">ngrok</a><br>is a reverse proxy that creates a secure tunnel from a public endpoint to a locally running web service.<br>ngrok captures and analyzes all traffic over the tunnel for later inspection and replay.</p>
</blockquote>
<p>简单来说，ngrok最主要的功能就是将本地的端口映射到外网的某个端口，以方便地完成很多需要外网访问却不希望deploy在服务器上的功能，比如现场demo、临时分享等。</p>
<p>目前ngrok有两种版本，一个是开源但是几近停止维护的ngrok 1.x，还有一个是闭源商用的ngrok 2.x。<br>这里我们选用1.x，方便self hosting部署以及自定义功能比如本文的题目：添加身份验证。</p>
<p>我们可以根据<a href="https://github.com/inconshreveable/ngrok/blob/master/docs/SELFHOSTING.md" target="_blank" rel="external">Self Hosting Doc</a>的文档完成最初的部署。<br>然而部署完我们会发现，原始版本的ngrok的server是没有身份验证功能的，也就是说任何人都可以通过ngrok 1.x的client使用我们的服务器，毕竟是私人的服务器，所以我希望给ngrok加上身份验证的功能。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>下面我们开始分析相关的ngrok的源代码。</p>
<p><code>src/ngrok/server/control.go#func NewControl</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">func NewControl(ctlConn conn.Conn, authMsg *msg.Auth) &#123;</div><div class="line"></div><div class="line">	...</div><div class="line"></div><div class="line">	failAuth := func(e error) &#123;</div><div class="line">		_ = msg.WriteMsg(ctlConn, &amp;msg.AuthResp&#123;Error: e.Error()&#125;)</div><div class="line">		ctlConn.Close()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// register the clientid</div><div class="line">	c.id = authMsg.ClientId</div><div class="line">	if c.id == &quot;&quot; &#123;</div><div class="line">		// it&apos;s a new session, assign an ID</div><div class="line">		if c.id, err = util.SecureRandId(16); err != nil &#123;</div><div class="line">			failAuth(err)</div><div class="line">			return</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	...</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们发现这一段代码实现的正是某种访问控制的功能，这个<code>authMsg</code>里说不定包含了一些我们需要的验证信息，下面我们查看<code>authMsg</code>的定义。</p>
<p><code>src/ngrok/msg/msg.go#Auth struct</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// When a client opens a new control channel to the server</div><div class="line">// it must start by sending an Auth message.</div><div class="line">type Auth struct &#123;</div><div class="line">	Version   string // protocol version</div><div class="line">	MmVersion string // major/minor software version (informational only)</div><div class="line">	User      string</div><div class="line">	Password  string</div><div class="line">	OS        string</div><div class="line">	Arch      string</div><div class="line">	ClientId  string // empty for new sessions</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们看到了<code>User</code>和<code>Password</code>，下意识觉得这里有戏，我们需要查证这两个值的来源。<br>我们可以在client中寻找对应的参数设定位置。</p>
<p>&lt;过程略……&gt;</p>
<p>最终我们会发现，<code>Auth struct</code>中的User对应的正是client命令行参数中的<code>-authtoken</code><br>因此，我们可以在-authtoken中包含我们的验证信息。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>我们采用<code>-authtoken=&#39;username:password&#39;</code>的方式来进行验证。具体实现的话只需要在<code>src/ngrok/server/control.go#func NewControl</code>中添加对<code>Auth struct</code>中的<code>User</code>验证的方法就行。</p>
<p>我的实现方案是，可以手动创建并用<code>-secretPath</code>指定（默认在<code>/etc/ngrok-secrets</code>）存储用户名和密码的文件的位置，格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># username      password</div><div class="line">  example-user  example-password</div></pre></td></tr></table></figure>
<p>具体实现可以见我fork之后的<a href="https://github.com/prikevs/ngrok/commit/aa9b88d4e070069db6d8f88aa82526bcbcd1d0b6" target="_blank" rel="external">commit: add support to authenticate by token</a></p>
<p>以后使用时只需要加上-authtoken参数即可，如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ngrok -authtoken=&quot;username:password&quot; -proto=tcp 8888</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我只是添加了很简单的一种身份验证方式，大家其实可以根据自己的需求与其他验证系统结合起来=)</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/01/24/auto-build-system-for-chromium/" class="next">NEXT</a></div><div data-thread-key="2016/12/26/add-authentication-to-ngrok/" data-title="给ngrok添加身份验证" data-url="http://yoursite.com/2016/12/26/add-authentication-to-ngrok/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"kevinceblog"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2016 <a href="http://yoursite.com">Kevince Boole</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-72789490-1",'auto');ga('send','pageview');</script></body></html>